<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Singapore PSI Readings</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
        }
        .info-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #timestamp {
            color: #666;
            font-size: 14px;
        }
        #average-psi {
            font-size: 18px;
            font-weight: bold;
            padding: 8px 16px;
            border-radius: 4px;
            color: white;
        }
        #next-refresh {
            color: #666;
            font-size: 14px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 40px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #loading {
            text-align: center;
            padding: 20px;
        }
        #error {
            background-color: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            display: none;
        }
        .table-wrapper {
            overflow-x: auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .reading-name {
            font-weight: bold;
            color: #333;
            white-space: nowrap;
        }
        .psi-good {
            background-color: #4CAF50;
        }
        .psi-moderate {
            background-color: #2196F3;
        }
        .psi-unhealthy {
            background-color: #FF9800;
        }
        .psi-very-unhealthy {
            background-color: #F44336;
        }
        .psi-hazardous {
            background-color: #9C27B0;
        }
        .legend {
            margin-top: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .legend h3 {
            margin-bottom: 10px;
            color: #333;
        }
        .legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .legend-color {
            width: 30px;
            height: 20px;
            border-radius: 3px;
        }
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            h1 {
                font-size: 24px;
            }
            th, td {
                padding: 8px;
                font-size: 14px;
            }
            .info-bar {
                flex-direction: column;
                text-align: center;
            }
            .legend-items {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <h1>Singapore PSI Readings</h1>
    
    <div class="info-bar">
        <div id="timestamp">Loading...</div>
        <div id="average-psi"></div>
        <div id="next-refresh"></div>
    </div>

    <div id="loading">
        <div class="spinner"></div>
        <p>Loading PSI data...</p>
    </div>
    
    <div id="error"></div>
    
    <div class="table-wrapper" id="table-container"></div>

    <div class="legend">
        <h3>PSI Levels Guide</h3>
        <div class="legend-items">
            <div class="legend-item">
                <div class="legend-color psi-good"></div>
                <span>0-50: Good</span>
            </div>
            <div class="legend-item">
                <div class="legend-color psi-moderate"></div>
                <span>51-100: Moderate</span>
            </div>
            <div class="legend-item">
                <div class="legend-color psi-unhealthy"></div>
                <span>101-200: Unhealthy</span>
            </div>
            <div class="legend-item">
                <div class="legend-color psi-very-unhealthy"></div>
                <span>201-300: Very Unhealthy</span>
            </div>
            <div class="legend-item">
                <div class="legend-color psi-hazardous"></div>
                <span>300+: Hazardous</span>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://api.data.gov.sg/v1/environment/psi';
        const REFRESH_INTERVAL = 180000; // 3 minutes in milliseconds
        let refreshTimer;
        let countdownTimer;
        let secondsUntilRefresh = 180;
        
        function getPSIColor(value) {
            if (value <= 50) return 'psi-good';
            if (value <= 100) return 'psi-moderate';
            if (value <= 200) return 'psi-unhealthy';
            if (value <= 300) return 'psi-very-unhealthy';
            return 'psi-hazardous';
        }

        function startCountdown() {
            secondsUntilRefresh = 180;
            if (countdownTimer) clearInterval(countdownTimer);
            
            countdownTimer = setInterval(() => {
                secondsUntilRefresh--;
                const minutes = Math.floor(secondsUntilRefresh / 60);
                const seconds = secondsUntilRefresh % 60;
                document.getElementById('next-refresh').textContent = 
                    `Next refresh in: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (secondsUntilRefresh <= 0) {
                    clearInterval(countdownTimer);
                }
            }, 1000);
        }

        async function fetchPSIData() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                displayData(data);
                startCountdown();
            } catch (error) {
                showError('Failed to fetch data: ' + error.message);
            }
        }

        function displayData(data) {
            document.getElementById('loading').style.display = 'none';
            
            if (!data.items || data.items.length === 0) {
                showError('No data available');
                return;
            }

            const latestItem = data.items[0];
            const readings = latestItem.readings;
            const timestamp = latestItem.timestamp;

            // Display timestamp
            document.getElementById('timestamp').textContent = 
                `Last Updated: ${new Date(timestamp).toLocaleString()}`;

            // Calculate and display average PSI
            const psiValues = readings.psi_twenty_four_hourly;
            const psiArray = Object.values(psiValues).filter(v => typeof v === 'number');
            const avgPSI = Math.round(psiArray.reduce((a, b) => a + b, 0) / psiArray.length);
            const avgPSIElement = document.getElementById('average-psi');
            avgPSIElement.textContent = `Average PSI: ${avgPSI}`;
            avgPSIElement.className = getPSIColor(avgPSI);

            // Get all regions
            const regions = Object.keys(readings.o3_sub_index);

            // Create table
            let tableHTML = '<table><thead><tr><th>Reading Type</th>';
            regions.forEach(region => {
                tableHTML += `<th>${region.replace(/_/g, ' ').toUpperCase()}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';

            // All 12 reading types
            const readingTypes = [
                'o3_sub_index',
                'pm10_twenty_four_hourly',
                'pm10_sub_index',
                'co_sub_index',
                'pm25_twenty_four_hourly',
                'so2_sub_index',
                'co_eight_hour_max',
                'no2_one_hour_max',
                'so2_twenty_four_hourly',
                'pm25_sub_index',
                'psi_twenty_four_hourly',
                'o3_eight_hour_max'
            ];

            // Add rows for each reading type
            readingTypes.forEach(readingType => {
                if (readings[readingType]) {
                    tableHTML += '<tr>';
                    tableHTML += `<td class="reading-name">${readingType.replace(/_/g, ' ').toUpperCase()}</td>`;
                    regions.forEach(region => {
                        const value = readings[readingType][region];
                        let cellClass = '';
                        if (readingType === 'psi_twenty_four_hourly' && typeof value === 'number') {
                            cellClass = getPSIColor(value);
                        }
                        tableHTML += `<td class="${cellClass}">${value !== undefined ? value : 'N/A'}</td>`;
                    });
                    tableHTML += '</tr>';
                }
            });

            tableHTML += '</tbody></table>';
            document.getElementById('table-container').innerHTML = tableHTML;
        }

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function setupAutoRefresh() {
            if (refreshTimer) clearInterval(refreshTimer);
            refreshTimer = setInterval(fetchPSIData, REFRESH_INTERVAL);
        }

        // Initial fetch
        fetchPSIData();
        // Setup auto-refresh
        setupAutoRefresh();
    </script>
</body>
</html>